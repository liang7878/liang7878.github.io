---
title: 读《云原生数据库：原理与实践》-- 数据库查询引擎是如何运行的
abbrlink: 5a8a6c8d
date: 2023-10-18 21:30:16
tags:
  - 数据库
  - 阅读
---

数据库计算引擎也叫数据库查询引擎，主要负责数据库的查询处理过程。查询处理由查询执行和查询优化组成，是数据库最关键的功能之一。我们经常听到某某数据库做了存算分离，查询引擎就是存算分离中“算”的重要组成部分。

## 查询处理概述

### 查询处理

查询处理（Query Processing）是数据库管理系统进行查询语句执行的过程，本质上是将查询语句翻译成查询计划，即用户指定了要查某某数据，这一系列的工作应该如何与存储层交互。查询处理主要分为几个基本步骤：查询分析、查询检查、查询优化和查询执行：

- 查询分析和查询检查：数据库的语法分析模块会将查询语句翻译成语法树，在这个过程中会对查询语句进行分析和检查，确保其符合 SQL 语法规则，接着会基于语法树生成一个查询计划（假设我们没有缓存的查询计划）
- 查询优化：在有了初始的查询计划后，数据库会对查询计划做一些优化，以确保其高效执行。从优化内容来看查询优化主要分为代数优化和物理优化，其中代数优化指关系代数表达式的优化，物理优化指存取路径和底层操作算法的选择。从优化的方式来看，查询优化可以分为基于规则的优化和基于开销的优化，基于规则的优化会根据查询引擎中预先定义好的优化规则对查询计划记性优化，比如表达式优化、子查询优化、列裁剪等等，基于开销的优化则是基于多个查询计划计算开销，选取开销最小的查询计划。
- 查询执行：查询优化得到的查询计划最终会被用来从存储层读取数据。

### 并行查询

并行查询有两种方式，第一种是**查询间并行(Inter-Query Parallelism)**，第二种是**查询内并行(Intra-Query Parallelism)**。

**查询间并行**指多个查询或者事务在多个处理器和磁盘上并行执行，但是单个查询或者事务在某个处理器上还是以串行方式执行的。查询间并行可以有效地提高事务的吞吐量，扩展事务的处理能力，使得事务处理系统单位时间内能支持更大数量的事务。

**查询内并行**指单个查询在多个处理器和磁盘上并行执行，它对于一些运行时间很长的查询非常有效，因为查询内并行可以并行地执行单个查询中的不同部分，使得整个查询的计算并行化，从而缩短整个查询的执行时间。

单个查询的执行过程会涉及很多算子，比如选择运算、投影运算、连接运算和聚合运算等。总的来说，查询内并行有**算子内并行**和**算子间并行**两种方式。本质上来说，这类并行处理就是将互相无关联的计算过程并行化处理，以达到提高性能的目的，这里就不详细展开了


## 查询执行模型

**数据库的查询执行模型决定了数据库如何执行一个给定的查询计划(Query Plan)。** 

### 火山模型（Volcano Model）

这是最常见的执行模型， 也叫迭代模型（Iterator Model）。火山模型将关系代数中每一种操作都抽象为一个运算符(Operator)，将整个SQL构建成一棵运算符树，树中的每一个运算符例如连接、排序等都会实现一个Next()函数，树的父节点的Next()函数会调用子节点的Next()函数，子节点会将结果返回给父节点，从根节点到叶子节点自上而下地递归调用Next()函数，数据则自底向上被拉取处理。火山模型的这种处理方式也被称为拉取执行模型。

### 编译执行模型

编译执行也叫以数据为中心的代码生成(Data-Centric Code Generation)，是由HyPer￼率先提出的。它使用LLVM编译器框架将查询转换为紧凑、高效的代码，生成的代码对现代CPU体系结构十分友好，执行速度非常快，只需花费适度的编译时间，就会为查询带来出色的性能，极大地提高了查询执行的效率。

### 向量化执行模型

向量化执行模型是以火山模型为基础设计的，每个运算符实现一个Next()函数。与火山模型不同的是，向量化模型在迭代的过程中，每一个运算符的Next()函数返回的都是批量的数据而不只是一个元组。因为成批的返回数据会大量减少调用Next()函数的次数，减少了虚函数的调用。而且向量化模型允许在每个运算符中使用SIMD的同时处理多行数据。同时，向量化执行以块为单位处理数据，提高了CPU缓存的命中率。

## 查询优化概述

查询优化的目的是针对一个查询找出一个最有效的查询执行计划。尽量使得查询的总开销最小。查询优化有多种方法，按其优化的层次可分为逻辑查询优化和物理查询优化。逻辑查询优化指对关系代数表达式的优化，即基于等价规则对查询进行等价重写。物理查询优化是对存取路径和底层操作算法的选择，选择的方法有基于规则的启发式优化、基于代价估算的优化和两者结合的优化。

查询优化器会产生很多和给定查询等价的查询执行计划，最终选择执行代价最小的一个。
查询优化的一般步骤为：

- 依据查询重写规则，把给定的查询转换成等价的、更高效的查询。
- 根据不同的底层的操作算法，生成不同的查询执行计划。
- 选择代价最小的一个查询执行计划。

### 逻辑查询优化

其实就是基于规则的查询重写，常见的优化规则有：

- 列裁剪
- 投影消除
- 关联子查询去关联
- Max/Min 消除
- 谓词下推
- 分区裁剪
- TopN 和 Limit 下推

### 物理查询优化

物理优化是基于代价的优化，为上一阶段产生的逻辑执行计划制定物理执行计划。比如如何扫描表、选择索引时如何采用最优的索引进行表的访问、在对表进行连接时采用哪种连接算法、表的连接顺序如何选择、等等等等。

## 其他优化

### 物化视图

### 计划缓存

## PolarDB 查询引擎实践

